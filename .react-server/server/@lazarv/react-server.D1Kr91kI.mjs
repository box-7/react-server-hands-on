import{createContext as i,useContext as l,useState as y,useEffect as u}from"react";import c from"node:async_hooks";import{parentPort as p}from"node:worker_threads";import d from"picocolors";const P="PAGE_ROOT",S=i({}),g=i({url:"/",outlet:null,refresh:()=>{},prefetch:()=>{},navigate:()=>{},replace:()=>{},abort:()=>{}}),E=i({resourceKey:0,error:null});function w(){return l(S)}function I(){return l(g)}class L{constructor(){this.store=new Map,this.contextMap=new Map,this.hook=c.createHook({init:(t,o,e)=>{this.contextMap.has(e)&&this.contextMap.set(t,this.contextMap.get(e))},destroy:t=>{this.contextMap.delete(t)}}),this.hook.enable()}run(t,o,...e){const n=c.executionAsyncId();this.contextMap.set(n,t);let s;try{s=o(...e)}finally{this.contextMap.delete(n)}return s}enterWith(t){const o=c.executionAsyncId();this.store.set(o,t)}getStore(){const t=c.executionAsyncId();return this.store.get(t)||this.contextMap.get(t)}}let h=p===null;class x{constructor(){typeof c.AsyncLocalStorage<"u"?this.asyncLocalStorage=new c.AsyncLocalStorage:(h&&(console.warn(d.yellow("AsyncLocalStorage is not supported, falling back to async hooks implementation")),h=!1),this.customAsyncLocalStorage=new L)}run(t,o,...e){return this.asyncLocalStorage?this.asyncLocalStorage.run(t,o,...e):this.customAsyncLocalStorage.run(t,o,...e)}enterWith(t){this.asyncLocalStorage?this.asyncLocalStorage.enterWith(t):this.customAsyncLocalStorage.enterWith(t)}getStore(){return this.asyncLocalStorage?this.asyncLocalStorage.getStore():this.customAsyncLocalStorage.getStore()}}const A=globalThis.__react_server_http_context__=globalThis.__react_server_http_context__||new x;function _(){return A.getStore()}function f(r){const[t,o]=y(typeof window<"u"?window.location:_()?.url),{subscribe:e}=w(),{outlet:n}=l(g);return u(()=>{const s=new AbortController,a=()=>{o(window.location)};return window.addEventListener("popstate",a,{signal:s.signal}),window.addEventListener("pushstate",a,{signal:s.signal}),()=>s.abort()},[]),u(()=>{const s=e(r??n,a=>o(new URL(a,window.location)));return()=>s()},[r,n,t]),t}function O(r){const t=f(r),o=t?new URLSearchParams(t.search):null;return o?Array.from(o.entries()).reduce((e,[n,s])=>(n in e?(Array.isArray(e[n])||(e[n]=[e[n]]),e[n].push(s)):e[n]=s,e),{}):null}function v(r){return f(r)?.pathname??null}export{S as C,g as F,P,E as a,f as b,O as c,v as d,I as e,w as u};
